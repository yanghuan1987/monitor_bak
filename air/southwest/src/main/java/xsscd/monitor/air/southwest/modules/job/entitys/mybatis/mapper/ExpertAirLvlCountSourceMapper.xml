<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="xsscd.monitor.air.southwest.modules.job.entitys.mybatis.mapper.ExpertAirLvlCountSourceMapper">
    <resultMap id="BaseResultMap" type="xsscd.monitor.air.southwest.modules.job.entitys.mybatis.dto.ExpertAirLvlCountSource">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="datetime" property="dateTime" jdbcType="TIMESTAMP"/>
        <result column="ProvinceName" property="provinceName" jdbcType="VARCHAR"/>
        <result column="areaName" property="areaName" jdbcType="VARCHAR"/>
        <result column="CityName" property="cityName" jdbcType="VARCHAR"/>
        <result column="CityCode" property="cityCode" jdbcType="VARCHAR"/>
        <result column="quality_score" property="qualityScore" jdbcType="VARCHAR"/>
        <result column="pm2_5_score" property="pm25Score" jdbcType="VARCHAR"/>
        <result column="aqi_score" property="aqiScore" jdbcType="VARCHAR"/>
        <result column="primarypollutant1_score" property="primaryPollutant1Score" jdbcType="VARCHAR"/>
    </resultMap>
    <sql id="Base_Column_List">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        datetime,
        ProvinceName,
        areaName,
        CityName,
        CityCode,
        quality_score,
        pm2_5_score,
        aqi_score,
        primarypollutant1_score
    </sql>
    <sql id="Base_Where_Case">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <where>
            <if test="id != null">
                AND id = #{id,jdbcType=BIGINT}
            </if>
        </where>
    </sql>
    <select id="selects" resultMap="BaseResultMap"
            parameterType="xsscd.monitor.air.southwest.modules.job.entitys.mybatis.dto.vo.SelectPiontVO">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        SELECT
        datetime,
        ProvinceName,
        areaName,
        CityName,
        CityCode,
        quality_score,
        pm2_5_score,
        aqi_score,
        primarypollutant1_score
        FROM
        (
        SELECT
        datetime,
        ProvinceName,
        areaName,
        CityName,
        CityCode,
        quality_real,
        quality1,
        primarypollutant_real,
        primarypollutant1,
        pm2_5,
        pm2_5_real,
        aqi,
        aqi_real,
        PM25_le,
        CASE
        WHEN aqi = aqi_real THEN
        100
        WHEN aqi <![CDATA[ >=  ]]> aqi_real THEN
        (1 -(aqi_real - aqi) / aqi_real) * 100
        WHEN aqi <![CDATA[ >  ]]> aqi_real THEN
        (1 -(aqi - aqi_real) / aqi) * 100
        ELSE
        0
        END aqi_score,
        CASE
        WHEN pm2_5 = pm2_5_real THEN
        100
        WHEN pm2_5 <![CDATA[ >=  ]]> pm2_5_real THEN
        (
        1 - (pm2_5_real - pm2_5) / pm2_5_real
        ) * 100
        WHEN pm2_5 <![CDATA[ >  ]]> pm2_5_real THEN
        (1 -(pm2_5 - pm2_5_real) / pm2_5) * 100
        ELSE
        0
        END pm2_5_score,
        CASE
        WHEN CHARINDEX(
        primarypollutant_real,
        primarypollutant1
        ) <![CDATA[ >  ]]> 0
        OR (
        primarypollutant_real = '无'
        AND CHARINDEX(quality_real, quality1) <![CDATA[ >  ]]> 0
        ) THEN
        100
        ELSE
        0
        END primarypollutant1_score,
        CASE
        WHEN CHARINDEX(quality_real, quality1) <![CDATA[ >  ]]> 0 THEN
        100
        ELSE
        0
        END quality_score,
        CASE
        WHEN quality_real IS NOT NULL THEN
        1
        ELSE
        0
        END quality_day,
        CASE
        WHEN quality1 IS NOT NULL THEN
        1
        ELSE
        0
        END quality_f_day,
        CASE
        WHEN CHARINDEX(
        primarypollutant_real,
        primarypollutant1
        ) <![CDATA[ >  ]]> 0
        OR (
        primarypollutant_real = '无'
        AND CHARINDEX(quality_real, quality1) <![CDATA[ >  ]]> 0
        ) THEN
        1
        ELSE
        0
        END primarypollutant1_day,
        CASE
        WHEN CHARINDEX(quality_real, quality1) <![CDATA[ >  ]]> 0 THEN
        1
        ELSE
        0
        END quality_accurate,
        CASE
        WHEN quality_real = quality1 THEN
        1
        WHEN CHARINDEX(quality_real, quality1) <![CDATA[ >  ]]> 0 THEN
        0.5
        WHEN quality_real = quality1 THEN
        1
        ELSE
        0
        END quality_hit,
        CASE
        WHEN quality_real = '重度污染'
        OR quality_real = '严重污染' THEN
        1
        ELSE
        0
        END quality_heavy,
        CASE
        WHEN CHARINDEX('重度污染', quality1) <![CDATA[ >  ]]> 0
        OR CHARINDEX('严重污染', quality1) <![CDATA[ >  ]]> 0 THEN
        1
        ELSE
        0
        END quality_f_heavy,
        CASE
        WHEN (
        quality_real = '重度污染'
        OR quality_real = '严重污染'
        )
        AND (
        CHARINDEX('重度污染', quality1) <![CDATA[ >  ]]> 0
        OR CHARINDEX('严重污染', quality1) <![CDATA[ >  ]]> 0
        ) THEN
        1
        ELSE
        0
        END quality_heavy_accurate,
        CASE
        WHEN (
        quality_real = '重度污染'
        AND CHARINDEX('重度污染', quality1) = 0
        )
        OR (
        quality_real = '严重污染'
        AND CHARINDEX('严重污染', quality1) = 0
        ) THEN
        1
        ELSE
        0
        END quality_heavy_false,
        CASE
        WHEN (
        quality_real <![CDATA[ <>  ]]> '重度污染'
        AND quality_real <![CDATA[ <>  ]]> '严重污染'
        )
        AND (
        CHARINDEX('重度污染', quality1) <![CDATA[ >  ]]> 0
        OR CHARINDEX('严重污染', quality1) <![CDATA[ >  ]]> 0
        ) THEN
        1
        ELSE
        0
        END quality_heavy_empty
        FROM
        (
        SELECT
        b.datetime,
        p.ProvinceName,
        ca.areaName,
        a.CityName,
        a.CityCode,
        b.AQI AS aqi_real,
        CASE
        WHEN b.Chiefly_Infectant = '—' THEN
        REPLACE(
        b.Chiefly_Infectant,
        '—',
        '无'
        )
        ELSE
        REPLACE(
        b.Chiefly_Infectant,
        'O3_8',
        '臭氧'
        )
        END primarypollutant_real,
        b.GradeDescription quality_real,
        b.PM25 AS pm2_5_real,
        dbo.GetStrArrayStrOfIndex (f.quality, '|', #{forcastDay} /*{day}*/) quality1,
        (
        CAST (
        CASE ISNUMERIC(
        dbo.GetStrArrayStrOfIndex (
        dbo.GetStrArrayStrOfIndex (f.pm2_5, '|', #{forcastDay} /*{day}*/),
        '~',
        1
        )
        )
        WHEN 0 THEN
        0
        ELSE
        dbo.GetStrArrayStrOfIndex (
        dbo.GetStrArrayStrOfIndex (f.pm2_5, '|', #{forcastDay} /*{day}*/),
        '~',
        1
        )
        END AS FLOAT
        ) <![CDATA[ +  ]]> CAST (
        CASE ISNUMERIC(
        dbo.GetStrArrayStrOfIndex (
        dbo.GetStrArrayStrOfIndex (f.pm2_5, '|', #{forcastDay} /*{day}*/),
        '~',
        2
        )
        )
        WHEN 0 THEN
        0
        ELSE
        dbo.GetStrArrayStrOfIndex (
        dbo.GetStrArrayStrOfIndex (f.pm2_5, '|', #{forcastDay} /*{day}*/),
        '~',
        2
        )
        END AS FLOAT
        )
        ) / 2 pm2_5,
        (
        CAST (
        CASE ISNUMERIC(
        dbo.GetStrArrayStrOfIndex (
        dbo.GetStrArrayStrOfIndex (f.aqi, '|', #{forcastDay} /*{day}*/),
        '~',
        1
        )
        )
        WHEN 0 THEN
        0
        ELSE
        dbo.GetStrArrayStrOfIndex (
        dbo.GetStrArrayStrOfIndex (f.aqi, '|', #{forcastDay} /*{day}*/),
        '~',
        1
        )
        END AS FLOAT
        ) <![CDATA[ +  ]]> CAST (
        CASE ISNUMERIC(
        dbo.GetStrArrayStrOfIndex (
        dbo.GetStrArrayStrOfIndex (f.aqi, '|', #{forcastDay} /*{day}*/),
        '~',
        2
        )
        )
        WHEN 0 THEN
        0
        ELSE
        dbo.GetStrArrayStrOfIndex (
        dbo.GetStrArrayStrOfIndex (f.aqi, '|', #{forcastDay} /*{day}*/),
        '~',
        2
        )
        END AS FLOAT
        )
        ) / 2 aqi,
        (
        CASE
        WHEN CAST (
        CASE ISNUMERIC(b.PM25)
        WHEN 0 THEN
        0
        ELSE
        b.PM25
        END AS FLOAT
        ) <![CDATA[ >=  ]]> CAST (
        CASE ISNUMERIC(
        dbo.GetStrArrayStrOfIndex (
        dbo.GetStrArrayStrOfIndex (f.pm2_5, '|', #{forcastDay} /*{day}*/),
        '~',
        1
        )
        )
        WHEN 0 THEN
        0
        ELSE
        dbo.GetStrArrayStrOfIndex (
        dbo.GetStrArrayStrOfIndex (f.pm2_5, '|', #{forcastDay} /*{day}*/),
        '~',
        1
        )
        END AS FLOAT
        )
        AND CAST (
        CASE ISNUMERIC(b.PM25)
        WHEN 0 THEN
        0
        ELSE
        b.PM25
        END AS FLOAT
        ) <![CDATA[ <=  ]]> CAST (
        CASE ISNUMERIC(
        dbo.GetStrArrayStrOfIndex (
        dbo.GetStrArrayStrOfIndex (f.pm2_5, '|', #{forcastDay} /*{day}*/),
        '~',
        2
        )
        )
        WHEN 0 THEN
        0
        ELSE
        dbo.GetStrArrayStrOfIndex (
        dbo.GetStrArrayStrOfIndex (f.pm2_5, '|', #{forcastDay} /*{day}*/),
        '~',
        2
        )
        END AS FLOAT
        ) THEN
        1
        ELSE
        0
        END
        ) PM25_le,
        dbo.GetStrArrayStrOfIndex (
        f.primarypollutant,
        '|',
        #{forcastDay} /*{day}*/
        ) primarypollutant1
        FROM
        southwestCity a
        LEFT JOIN CityArea ca ON ca.id = a.areaId
        LEFT JOIN Province1 p ON p.id = ca.provincesId
        LEFT JOIN (
        SELECT
        *
        FROM
        GW_Fact_CityDay
        WHERE
        datetime <![CDATA[ >=  ]]> #{dateST} /*{time}*/
        AND datetime <![CDATA[ <=  ]]> #{dateED} /*{time}*/
        ) b ON a.CityCode1 = b.citycode
        LEFT JOIN (
        SELECT
        forecastaudit.citycode,
        DATEADD(
        DAY,
        #{forcastDay},
        forecastaudit.timepoint
        ) timepoint,
        forecastaudit.aqi,
        forecastaudit.content,
        REPLACE(
        forecastaudit.primarypollutant,
        '臭氧8小时',
        '臭氧'
        ) primarypollutant,
        REPLACE(
        forecastaudit.quality,
        '至',
        '或'
        ) quality,
        forecastset.pm2_5_dr AS pm2_5
        FROM
        forecastaudit
        LEFT JOIN forecastset ON forecastaudit.citycode = forecastset.citycode
        AND forecastaudit.timepoint = forecastset.timepoint
        WHERE
        forecastaudit.timepoint <![CDATA[ >=  ]]> DATEADD(DAY,-#{forcastDay},#{dateST}) /*{time}*/
        AND forecastaudit.timepoint <![CDATA[ <=  ]]> DATEADD(DAY,-#{forcastDay},#{dateED}) /*{time}*/
        ) f ON a.CityCode1 / 100 = f.citycode
        AND f.timepoint = b.datetime
        ) data
        ) m
    </select>
</mapper>